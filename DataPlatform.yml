AWSTemplateFormatVersion: "2010-09-09"
Description: "CHEAP Data Platform: VPC (2 public + 3 private in 3 AZ), 1 NAT (cheap), S3, Glue, Redshift Serverless, Athena WG, Airflow on ECS Fargate + EFS + scheduled DAG sync"

Parameters:
  ProjectName:
    Type: String
    Default: "data-platform"
    Description: "Name prefix for all resources"

  RedshiftMasterUsername:
    Type: String
    Default: "admin"
    Description: "Redshift master username"

  RedshiftMasterPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: "Redshift master password (min 8 chars)"

  AirflowAdminUsername:
    Type: String
    Default: "admin"
    Description: "Airflow admin username"

  AirflowAdminPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: "Airflow admin password (min 8 chars)"

  AirflowDbUsername:
    Type: String
    Default: "airflow"
    Description: "RDS username for Airflow metadata DB"

  AirflowDbPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: "RDS password for Airflow metadata DB"

  AirflowWebIngressCidr:
    Type: String
    Default: "0.0.0.0/0"
    Description: "CIDR allowed to access Airflow Web UI (8080). Recommended: your IP/32"

Resources:
  # =======================
  # Networking (CHEAP: 1 NAT + 3 private subnets in 3 AZ)
  # =======================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-vpc"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-igw"

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ---- Public (2 AZ) ----
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.1.0/24"
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet-1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.2.0/24"
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet-2"

  # ---- Private (3 AZ) ----
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.11.0/24"
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet-1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.12.0/24"
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet-2"

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.13.0/24"
      AvailabilityZone: !Select [2, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet-3"

  # ---- Public routing ----
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-rt"

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # ---- CHEAP NAT (ONE) ----
  NatEip1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    DependsOn: AttachGateway
    Properties:
      AllocationId: !GetAtt NatEip1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-nat-1"

  # ---- Private routing (ONE route table for all private subnets) ----
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-rt"

  PrivateDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: !Ref NatGateway1

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # =======================
  # S3
  # =======================
  DataLakeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ProjectName}-data-lake-${AWS::Region}-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  AirflowBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ProjectName}-airflow-${AWS::Region}-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  AthenaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ProjectName}-athena-results-${AWS::Region}-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # =======================
  # CloudWatch Logs
  # =======================
  AirflowLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ecs/${ProjectName}-airflow"
      RetentionInDays: 14

  DAGSyncLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ecs/${ProjectName}-dag-sync"
      RetentionInDays: 14

  # =======================
  # IAM
  # =======================
  GlueServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-glue-service-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole"
      Policies:
        - PolicyName: GlueS3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:GetObject"
                  - "s3:PutObject"
                  - "s3:DeleteObject"
                  - "s3:ListBucket"
                Resource:
                  - !Sub "arn:aws:s3:::${DataLakeBucket}"
                  - !Sub "arn:aws:s3:::${DataLakeBucket}/*"
        - PolicyName: GlueSecretsManagerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue"
                  - "secretsmanager:DescribeSecret"
                Resource: "*"
        - PolicyName: GlueRedshiftServerlessAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "redshift-serverless:*"
                Resource: "*"

  RedshiftGlueAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - redshift.amazonaws.com
                - redshift-serverless.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: GlueCatalogRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "glue:GetDatabase"
                  - "glue:GetDatabases"
                  - "glue:GetTable"
                  - "glue:GetTables"
                  - "glue:GetPartitions"
                Resource: "*"

  RedshiftServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-redshift-service-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - redshift.amazonaws.com
                - redshift-serverless.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: RedshiftS3Read
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:GetObject"
                  - "s3:GetObjectVersion"
                  - "s3:ListBucket"
                  - "s3:GetBucketLocation"
                Resource:
                  - !Sub "arn:aws:s3:::${DataLakeBucket}"
                  - !Sub "arn:aws:s3:::${DataLakeBucket}/*"

  AirflowExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-airflow-execution-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"

  AirflowTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-airflow-task-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: AirflowPlatformAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:*"
                  - "glue:*"
                  - "athena:*"
                  - "redshift:*"
                  - "redshift-data:*"
                  - "logs:*"
                Resource: "*"

  DAGSyncTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-dag-sync-task-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: DAGSyncS3Read
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:GetObject"
                  - "s3:ListBucket"
                Resource:
                  - !Sub "arn:aws:s3:::${AirflowBucket}"
                  - !Sub "arn:aws:s3:::${AirflowBucket}/*"
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"

  EventBridgeExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-eventbridge-execution-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: EventBridgeECSRunTask
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecs:RunTask"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "iam:PassRole"
                Resource:
                  - !GetAtt AirflowExecutionRole.Arn
                  - !GetAtt DAGSyncTaskRole.Arn

  # =======================
  # Security Groups
  # =======================
  AirflowSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Airflow ECS tasks SG"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: !Ref AirflowWebIngressCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: "0.0.0.0/0"

  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "EFS SG"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref AirflowSecurityGroup

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "RDS SG (allow from Airflow)"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref AirflowSecurityGroup

  GlueCrawlerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Glue crawler SG"
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: "0.0.0.0/0"

  RedshiftSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Redshift Serverless SG"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5439
          ToPort: 5439
          SourceSecurityGroupId: !Ref GlueCrawlerSecurityGroup
        - IpProtocol: tcp
          FromPort: 5439
          ToPort: 5439
          SourceSecurityGroupId: !Ref AirflowSecurityGroup

  # =======================
  # Glue (DB + crawlers + JDBC connections)
  # =======================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub "${ProjectName}_database"
        Description: "Main database for data platform"

  GlueCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: !Sub "${ProjectName}-s3-crawler"
      Role: !GetAtt GlueServiceRole.Arn
      DatabaseName: !Ref GlueDatabase
      Targets:
        S3Targets:
          - Path: !Sub "s3://${DataLakeBucket}/raw/"
            Exclusions:
              - "**/_temporary/**"
              - "**/.spark-staging/**"
              - "**/.DS_Store/**"
          - Path: !Sub "s3://${DataLakeBucket}/bronze/"
            Exclusions:
              - "**/_temporary/**"
              - "**/.spark-staging/**"
          - Path: !Sub "s3://${DataLakeBucket}/silver/"
            Exclusions:
              - "**/_temporary/**"
              - "**/.spark-staging/**"
          - Path: !Sub "s3://${DataLakeBucket}/gold/"
            Exclusions:
              - "**/_temporary/**"
              - "**/.spark-staging/**"
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Configuration: |
        {
          "Version": 1.0,
          "CrawlerOutput": {
            "Partitions": { "AddOrUpdateBehavior": "InheritFromTable" },
            "Tables": { "AddOrUpdateBehavior": "MergeNewColumns" }
          }
        }

  # =======================
  # Redshift Serverless (needs 3 subnets in 3 AZ + enough free IPs)
  # =======================
  RedshiftServerlessNamespace:
    Type: AWS::RedshiftServerless::Namespace
    Properties:
      NamespaceName: !Sub "${ProjectName}-namespace"
      AdminUsername: !Ref RedshiftMasterUsername
      AdminUserPassword: !Ref RedshiftMasterPassword
      IamRoles:
        - !GetAtt RedshiftGlueAccessRole.Arn
        - !GetAtt RedshiftServiceRole.Arn

  RedshiftServerlessWorkgroup:
    Type: AWS::RedshiftServerless::Workgroup
    Properties:
      WorkgroupName: !Sub "${ProjectName}-workgroup"
      NamespaceName: !Ref RedshiftServerlessNamespace
      BaseCapacity: 8
      PubliclyAccessible: false
      EnhancedVpcRouting: true
      SecurityGroupIds:
        - !Ref RedshiftSecurityGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3

  RedshiftConnectionAZ1:
    Type: AWS::Glue::Connection
    Properties:
      CatalogId: !Ref AWS::AccountId
      ConnectionInput:
        Name: !Sub "${ProjectName}-redshift-connection-az1"
        Description: "JDBC connection to Redshift Serverless (AZ1 subnet)"
        ConnectionType: JDBC
        ConnectionProperties:
          JDBC_CONNECTION_URL: !Sub
            - "jdbc:redshift://${Endpoint}:5439/dev"
            - Endpoint: !GetAtt RedshiftServerlessWorkgroup.Workgroup.Endpoint.Address
          USERNAME: !Ref RedshiftMasterUsername
          PASSWORD: !Ref RedshiftMasterPassword
        PhysicalConnectionRequirements:
          SecurityGroupIdList:
            - !Ref GlueCrawlerSecurityGroup
          SubnetId: !Ref PrivateSubnet1

  RedshiftConnectionAZ2:
    Type: AWS::Glue::Connection
    Properties:
      CatalogId: !Ref AWS::AccountId
      ConnectionInput:
        Name: !Sub "${ProjectName}-redshift-connection-az2"
        Description: "JDBC connection to Redshift Serverless (AZ2 subnet)"
        ConnectionType: JDBC
        ConnectionProperties:
          JDBC_CONNECTION_URL: !Sub
            - "jdbc:redshift://${Endpoint}:5439/dev"
            - Endpoint: !GetAtt RedshiftServerlessWorkgroup.Workgroup.Endpoint.Address
          USERNAME: !Ref RedshiftMasterUsername
          PASSWORD: !Ref RedshiftMasterPassword
        PhysicalConnectionRequirements:
          SecurityGroupIdList:
            - !Ref GlueCrawlerSecurityGroup
          SubnetId: !Ref PrivateSubnet2

  RedshiftCrawler:
    Type: AWS::Glue::Crawler
    DependsOn: RedshiftServerlessWorkgroup
    Properties:
      Name: !Sub "${ProjectName}-redshift-crawler"
      Role: !GetAtt GlueServiceRole.Arn
      DatabaseName: !Ref GlueDatabase
      Targets:
        JdbcTargets:
          - ConnectionName: !Ref RedshiftConnectionAZ1
            Path: "dev/%"
            Exclusions:
              - "information_schema/%"
              - "pg_catalog/%"
              - "pg_toast/%"
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG

  # =======================
  # Athena
  # =======================
  AthenaWorkGroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: !Sub "${ProjectName}-athena-workgroup"
      Description: "Primary workgroup for data platform"
      State: ENABLED
      WorkGroupConfiguration:
        ResultConfiguration:
          OutputLocation: !Sub "s3://${AthenaBucket}/query-results/"
        EnforceWorkGroupConfiguration: false

  # =======================
  # RDS Postgres for Airflow metadata (private subnets; no EngineVersion pin for stability)
  # =======================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for Airflow metadata database"
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3

  AirflowDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-airflow-db"
      DBInstanceClass: "db.t3.micro"
      Engine: "postgres"
      MasterUsername: !Ref AirflowDbUsername
      MasterUserPassword: !Ref AirflowDbPassword
      AllocatedStorage: 20
      DBName: "airflow"
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 0
      DeletionProtection: false

  # =======================
  # EFS for Airflow DAGs (mount targets only in AZ0/AZ1 - where ECS services run)
  # =======================
  AirflowEFS:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      FileSystemTags:
        - Key: Name
          Value: !Sub "${ProjectName}-airflow-efs"

  AirflowEFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref AirflowEFS
      SubnetId: !Ref PrivateSubnet1
      SecurityGroups:
        - !Ref EFSSecurityGroup

  AirflowEFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref AirflowEFS
      SubnetId: !Ref PrivateSubnet2
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # =======================
  # ECS Cluster
  # =======================
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${ProjectName}-airflow-cluster"
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1

  # =======================
  # Airflow Task Definitions
  # =======================
  AirflowWebserverTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: AirflowLogGroup
    Properties:
      Family: !Sub "${ProjectName}-airflow-webserver"
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      Cpu: 512
      Memory: 1024
      ExecutionRoleArn: !GetAtt AirflowExecutionRole.Arn
      TaskRoleArn: !GetAtt AirflowTaskRole.Arn
      ContainerDefinitions:
        - Name: "airflow-webserver"
          Image: "apache/airflow:2.8.1"
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: "AIRFLOW__CORE__EXECUTOR"
              Value: "LocalExecutor"
            - Name: "AIRFLOW__DATABASE__SQL_ALCHEMY_CONN"
              Value: !Sub "postgresql+psycopg2://${AirflowDbUsername}:${AirflowDbPassword}@${AirflowDatabase.Endpoint.Address}:5432/airflow"
            - Name: "AIRFLOW__CORE__DAGS_FOLDER"
              Value: "/opt/airflow/dags"
            - Name: "AIRFLOW__CORE__LOAD_EXAMPLES"
              Value: "False"
            - Name: "_AIRFLOW_WWW_USER_USERNAME"
              Value: !Ref AirflowAdminUsername
            - Name: "_AIRFLOW_WWW_USER_PASSWORD"
              Value: !Ref AirflowAdminPassword
          MountPoints:
            - SourceVolume: "airflow-efs"
              ContainerPath: "/opt/airflow/dags"
          Command:
            - "bash"
            - "-c"
            - |
              set -e
              echo "Migrating Airflow DB..."
              airflow db migrate

              echo "Creating admin user (ignore if exists)..."
              airflow users create \
                --username "${_AIRFLOW_WWW_USER_USERNAME}" \
                --firstname Admin \
                --lastname User \
                --role Admin \
                --email admin@example.com \
                --password "${_AIRFLOW_WWW_USER_PASSWORD}" || true

              echo "Starting webserver..."
              exec airflow webserver
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AirflowLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: "webserver"
      Volumes:
        - Name: "airflow-efs"
          EFSVolumeConfiguration:
            FileSystemId: !Ref AirflowEFS

  AirflowSchedulerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: AirflowLogGroup
    Properties:
      Family: !Sub "${ProjectName}-airflow-scheduler"
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      Cpu: 512
      Memory: 1024
      ExecutionRoleArn: !GetAtt AirflowExecutionRole.Arn
      TaskRoleArn: !GetAtt AirflowTaskRole.Arn
      ContainerDefinitions:
        - Name: "airflow-scheduler"
          Image: "apache/airflow:2.8.1"
          Essential: true
          Environment:
            - Name: "AIRFLOW__CORE__EXECUTOR"
              Value: "LocalExecutor"
            - Name: "AIRFLOW__DATABASE__SQL_ALCHEMY_CONN"
              Value: !Sub "postgresql+psycopg2://${AirflowDbUsername}:${AirflowDbPassword}@${AirflowDatabase.Endpoint.Address}:5432/airflow"
            - Name: "AIRFLOW__CORE__DAGS_FOLDER"
              Value: "/opt/airflow/dags"
            - Name: "AIRFLOW__CORE__LOAD_EXAMPLES"
              Value: "False"
          MountPoints:
            - SourceVolume: "airflow-efs"
              ContainerPath: "/opt/airflow/dags"
          Command:
            - "bash"
            - "-c"
            - |
              set -e
              echo "Waiting for DB..."
              for i in {1..60}; do
                airflow db check && break
                sleep 5
              done
              echo "Starting scheduler..."
              exec airflow scheduler
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AirflowLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: "scheduler"
      Volumes:
        - Name: "airflow-efs"
          EFSVolumeConfiguration:
            FileSystemId: !Ref AirflowEFS

  # =======================
  # Airflow ECS Services
  # =======================
  AirflowWebserverService:
    Type: AWS::ECS::Service
    DependsOn:
      - AirflowDatabase
      - AirflowEFSMountTarget1
      - AirflowEFSMountTarget2
    Properties:
      ServiceName: !Sub "${ProjectName}-airflow-webserver"
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref AirflowWebserverTaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups: [!Ref AirflowSecurityGroup]
          Subnets: [!Ref PublicSubnet1, !Ref PublicSubnet2]

  AirflowSchedulerService:
    Type: AWS::ECS::Service
    DependsOn:
      - AirflowDatabase
      - AirflowEFSMountTarget1
      - AirflowEFSMountTarget2
    Properties:
      ServiceName: !Sub "${ProjectName}-airflow-scheduler"
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref AirflowSchedulerTaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: [!Ref AirflowSecurityGroup]
          Subnets: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]

  # =======================
  # DAG Sync Task + EventBridge schedule
  # =======================
  DAGSyncTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: DAGSyncLogGroup
    Properties:
      Family: !Sub "${ProjectName}-dag-sync"
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      Cpu: 256
      Memory: 512
      ExecutionRoleArn: !GetAtt AirflowExecutionRole.Arn
      TaskRoleArn: !GetAtt DAGSyncTaskRole.Arn
      ContainerDefinitions:
        - Name: "dag-sync"
          Image: "amazon/aws-cli:latest"
          Essential: true
          Environment:
            - Name: "S3_BUCKET"
              Value: !Ref AirflowBucket
            - Name: "S3_PREFIX"
              Value: "dags/"
            - Name: "EFS_MOUNT_PATH"
              Value: "/opt/airflow/dags"
          MountPoints:
            - SourceVolume: "airflow-efs"
              ContainerPath: "/opt/airflow/dags"
          Command:
            - "sh"
            - "-c"
            - |
              set -e
              echo "Sync DAGs from S3 to EFS..."
              mkdir -p "$EFS_MOUNT_PATH"
              aws s3 sync "s3://$S3_BUCKET/$S3_PREFIX" "$EFS_MOUNT_PATH" --delete --exact-timestamps
              echo "Done. Listing:"
              ls -la "$EFS_MOUNT_PATH"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref DAGSyncLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: "dag-sync"
      Volumes:
        - Name: "airflow-efs"
          EFSVolumeConfiguration:
            FileSystemId: !Ref AirflowEFS

  DAGSyncScheduleRule:
    Type: AWS::Events::Rule
    DependsOn:
      - AirflowEFSMountTarget1
      - AirflowEFSMountTarget2
    Properties:
      Name: !Sub "${ProjectName}-dag-sync-schedule"
      Description: "Trigger DAG sync every 5 minutes"
      ScheduleExpression: "rate(5 minutes)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt ECSCluster.Arn
          Id: "DAGSyncTarget"
          RoleArn: !GetAtt EventBridgeExecutionRole.Arn
          EcsParameters:
            TaskDefinitionArn: !Ref DAGSyncTaskDefinition
            LaunchType: FARGATE
            TaskCount: 1
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups: [!Ref AirflowSecurityGroup]
                Subnets: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]

Outputs:
  VPCId:
    Description: "VPC ID"
    Value: !Ref VPC
    Export:
      Name: !Sub "${ProjectName}-vpc-id"

  DataLakeBucketName:
    Description: "S3 Data Lake Bucket Name"
    Value: !Ref DataLakeBucket
    Export:
      Name: !Sub "${ProjectName}-data-lake-bucket"

  AirflowBucketName:
    Description: "S3 Airflow Bucket Name"
    Value: !Ref AirflowBucket
    Export:
      Name: !Sub "${ProjectName}-airflow-bucket"

  AthenaBucketName:
    Description: "S3 Athena Results Bucket Name"
    Value: !Ref AthenaBucket
    Export:
      Name: !Sub "${ProjectName}-athena-bucket"

  GlueDatabaseName:
    Description: "Glue Database Name"
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub "${ProjectName}-glue-database"

  RedshiftServerlessEndpoint:
    Description: "Redshift Serverless Workgroup Endpoint"
    Value: !GetAtt RedshiftServerlessWorkgroup.Workgroup.Endpoint.Address
    Export:
      Name: !Sub "${ProjectName}-redshift-endpoint"

  AthenaWorkGroupName:
    Description: "Athena WorkGroup Name"
    Value: !Ref AthenaWorkGroup
    Export:
      Name: !Sub "${ProjectName}-athena-workgroup"

  AirflowDbEndpoint:
    Description: "RDS endpoint for Airflow metadata DB"
    Value: !GetAtt AirflowDatabase.Endpoint.Address

  AirflowWebUrlHint:
    Description: "Airflow URL hint (use public task IP + :8080; better add ALB in non-free-tier)"
    Value: !Sub "http://<public-ip-of-webserver-task>:8080"